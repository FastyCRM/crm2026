КАНОН СОЗДАНИЯ МОДУЛЯ CRM2026

(обязателен для всех новых модулей)

0. Общий принцип

Модуль — это автономная бизнес-единица.
Админка — тупой shell.
Источник истины — БД.
Дизайн — только через существующую дизайн-систему.

Никаких догадок, фантазий и “улучшим потом”.

1. Где и как создаётся модуль
1.1. Создание модуля — ВСЕГДА в новом чате

Перед началом я обязан:

считать, что ничего не знаю, кроме этого канона

не использовать код из старых чатов, если ты прямо не сказал

1.2. Физическая структура модуля (СТРОГО)
/modules/<module_code>/
  <module_code>.php          // VIEW (UI)
  settings.php               // паспорт модуля (НЕ логика)
  README.md

  /assets/
    /php/
      handler.php            // ВСЯ бизнес-логика


❌ Запрещено:

добавлять css без разрешения

добавлять js без разрешения

добавлять подпапки “на будущее”

2. Регистрация модуля
2.1. Регистрация — ТОЛЬКО ВРУЧНУЮ

модуль НЕ регистрирует себя

модуль НЕ пишет в БД

запись в таблице modules создаётся вручную

Модуль обязан работать, если запись в БД уже есть.

2.2. Таблица modules — источник истины

Модуль НЕ читает:

settings.php других модулей

файловую систему

JSON

Он читает только БД через core.

3. settings.php — что это и чем НЕ является
3.1. Что это

settings.php — это:

паспорт

справочная информация

может использоваться ТОЛЬКО самим модулем

Пример допустимого использования:

показать название в заголовке

флаг has_settings

3.2. Чем НЕ является

settings.php НИКОГДА НЕ:

источник меню

источник ролей

источник enabled/menu

источник ACL

4. VIEW (<module>.php)
4.1. Роль файла

ТОЛЬКО HTML + минимальный PHP

НИКАКОЙ бизнес-логики

допустимы:

вывод данных

формы

кнопки

4.2. Обязательные проверки в начале
$uid = auth_user_id();
if (!$uid) {
    http_response_code(401);
    exit('Unauthorized');
}

$allowed = module_allowed_roles('<module_code>');
acl_guard($allowed);


Без этого модуль считается небезопасным.

4.3. UI — ТОЛЬКО дизайн-система

Разрешено использовать только существующие классы:

.card, .card__head, .card__body

.table

.input, .select

.btn, .btn.primary, .btn.danger, .btn.sm

.grid, .row, .stack

.notice

.muted, .title, .w100

❌ Запрещено:

свои CSS-классы

inline-CSS (кроме крайней необходимости)

JS “для удобства”

5. Handler (assets/php/handler.php)
5.1. Единственное место бизнес-логики

ВСЯ логика ТОЛЬКО здесь

VIEW не принимает решений

5.2. Обязательные защиты (ВСЕ)
if (!defined('ROOT_PATH')) {
    http_response_code(403);
    exit('Direct access forbidden');
}

$uid = auth_user_id();
if (!$uid) {
    http_response_code(401);
    exit('Unauthorized');
}

$allowed = module_allowed_roles('<module_code>');
acl_guard($allowed);

csrf_check($_POST['_csrf'] ?? null);


Если хотя бы одного пункта нет — модуль считается бракованным.

5.3. Работа с БД

ТОЛЬКО через PDO prepare

Никакого SQL-строительства строками

Никаких глобальных $pdo без db()

6. CSRF — жёсткий канон

генерация: csrf_token()

проверка: csrf_check()

csrf_check():

НЕ возвращает bool

сама делает 403 + exit

❌ Запрещено:

if (!csrf_...)

свои проверки в модулях

7. Админка (adm/index.php)

Модуль НЕ ВЛИЯЕТ на админку.

Админка:

не сканирует файловую систему

не читает settings.php

строит меню ТОЛЬКО из таблицы modules

проверяет enabled перед открытием

8. Что модуль НЕ имеет права делать

❌ Регистрировать себя
❌ Менять modules таблицу
❌ Подключать CSS/JS без разрешения
❌ Лезть в core
❌ Лезть в другие модули
❌ Делать “удобнее”, чем сказано

9. Что я обязан сделать в новом чате

Когда ты пишешь:

“Создай модуль X”

Я обязан:

Сначала кратко переспросить, если не указано:

только admin или нет

какие действия (CRUD / toggle / read-only)

Предложить строгую структуру

Дать ТОЛЬКО нужные файлы

Не добавлять ничего лишнего

Не использовать прошлые догадки

10. Ключевая мысль (для меня)

CRM2026 — не playground.
Каждый лишний класс, функция или “идея” — потенциальный баг.
Минимум. Ясность. Контроль.

Если хочешь, следующим шагом я могу:

сохранить этот текст как официальный MODULE_CANON.md

или использовать его как чек-лист перед каждым новым модулем (и ты сможешь меня тыкать в пункт)