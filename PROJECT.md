# Project Architecture Canon

## 1. Общая идея

Проект построен по принципу строгого разделения слоёв:

* **/site** — публичная статическая витрина
* **/adm** — административная оболочка (shell)
* **/core** — инфраструктурное ядро
* **/modules** — автономные бизнес-модули

Единая точка входа — `/index.php`.

---

## 2. Структура проекта

```
/index.php                      // Единая точка входа (dispatcher)

/site/                          // Публичная витрина (статическая)
  /css/
  /js/
  /img/
  /json/                        // Публичные статичные данные
    catalog.json
    pages.json
    settings.json
  /lk/                          // Личный кабинет (минимальный)
    index.html
    history.html
    profile.html
    lk.js
  index.html

/adm/                           // Админка (shell)
  /css/
  /js/
  /img/
  index.php | index.html

/core/                          // Ядро системы
  bootstrap.php                 // Инициализация, константы, сессии
  dispatcher.php                // Маршрутизация запросов
  db.php                        // Работа с БД
  auth.php                      // Аутентификация / сессии / токены
  acl.php                       // Контроль прав доступа
  validator.php                 // Валидация входных данных
  audit.php                     // Логирование действий
  json_builder.php              // Генерация /site/json/*.json
  helpers.php                   // Общие функции

/modules/                       // Автономные модули
  /<module_name>/
    <module_name>.php           // Вход модуля
    settings.php                // Метаданные и настройки
    /assets/
      /css/
      /js/
    /php/
      /view/
      /handler/
      /lib/
```

---

## 3. Публичная часть (/site)

1. `/site` является **статической витриной**, а не приложением.
2. `/site` получает данные **только из JSON-файлов** в `/site/json/`.
3. `/site`:

   * не работает с БД
   * не содержит бизнес-логики
   * не выполняет вычислений

JSON — это публичный слепок данных.

---

## 4. JSON-данные витрины

1. JSON-файлы обновляются **только по событию изменения данных**.
2. **Только core** имеет право записывать JSON.
3. Модулям запрещено:

   * писать JSON напрямую
   * знать пути к `/site/json/`
4. Модуль может лишь сигнализировать core о необходимости пересборки данных.

Генерация JSON выполняется через `core/json_builder.php`.

---

## 5. Личный кабинет пользователя

1. Личный кабинет реализован как отдельная зона `/site/lk/`.
2. `/site/lk/` **не использует JSON витрины**.
3. Работа ЛК происходит через API:

```
/site/lk → AJAX → /index.php → core → module → DB
```

4. История покупок / посещений:

   * хранится в отдельных таблицах БД
   * обслуживается отдельным модулем
5. Проверка авторизации выполняется через `core/auth.php`.

JSON никогда не используется для персональных данных.

---

## 6. Модули

1. Модуль — полностью автономная единица.
2. Модуль не зависит от других модулей.
3. Вся бизнес-логика размещается **только** в:

```
/modules/<module_name>/php/handler/
```

4. Модули взаимодействуют с системой **только через core**.

---

## 7. Intent и обработка действий

1. Любое действие оформляется как **intent** (массив / JSON), содержащий:

   * кто инициатор
   * какое действие
   * какие данные
2. Core выполняет:

   * разбор intent
   * валидацию
   * ACL
   * транзакции
   * вызов handler модуля
3. Core **не содержит бизнес-правил модулей**.

---

## 8. КРИТИЧЕСКОЕ ПРАВИЛО: АБСОЛЮТНЫЕ ПУТИ

### 8.1. Общее правило

Во всём проекте **используются только абсолютные пути** при подключении файлов.

❌ Запрещено:

```php
require 'db.php';
include '../core/auth.php';
```

✅ Обязательно:

```php
require_once PROJECT_ROOT . '/core/db.php';
require_once MODULES_PATH . '/orders/php/handler/create.php';
```

---

### 8.2. Обязательные константы

В `core/bootstrap.php`:

```php
define('PROJECT_ROOT', realpath(__DIR__ . '/../'));
define('CORE_PATH', PROJECT_ROOT . '/core');
define('MODULES_PATH', PROJECT_ROOT . '/modules');
define('SITE_PATH', PROJECT_ROOT . '/site');
```

Все `include / require` выполняются **только** через эти константы.

---

## 9. Итоговый принцип

> Публичная часть — статическая витрина на JSON. Личный кабинет и админка работают через core и БД. Core отвечает за безопасность, маршрутизацию и инфраструктуру. Модули автономны. Абсолютные пути обязательны.

---

**Статус документа:** утверждён как канон проекта.

